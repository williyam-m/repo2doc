{% extends 'base.html' %}
{% load static %}

{% block title %}Repo2Doc - Generate Documentation for Your Code{% endblock %}

{% block content %}
<div class="container">
    
    <div class="upload-form-container">
      <div class="upload-form">
        <form method="post" enctype="multipart/form-data" id="upload-form">
          {% csrf_token %}
          <div class="input-options-container">
            <div class="input-option">
              <div class="file-drop-area">
                <span class="drop-message">Drag and drop or upload your repo (zip)</span>
                <span class="choose-file">Choose file</span>
                <input type="file" name="code_file" id="file-input" class="file-input" accept=".zip">
                <div class="file-details" id="file-details"></div>
              </div>
            </div>
            
            <div class="input-option-divider">
              <span>OR</span>
            </div>
<div class="input-option">
              <div class="github-url-container">
                <span class="github-url-label">Enter GitHub Repository URL</span>
                <input type="text" name="github_url" id="github-url" placeholder="https://github.com/username/repository" class="github-url-input">
              </div>
            </div>
          </div>
          
          <!-- Auto-Sync Options for GitHub URLs -->
          <div class="github-sync-options" id="github-sync-options" style="display: none;">
            <div class="sync-option-header">
              <h4>Auto-Sync Settings</h4>
              <p class="sync-description">Keep your documentation synchronized with GitHub repository changes</p>
            </div>
            
            <div class="radio-options">
              <label class="sync-option">
                <input type="radio" name="auto_sync" value="disabled" id="sync-disabled" checked>
                <span class="sync-label">Manual Sync</span>
                <span class="sync-desc">Update documentation manually</span>
              </label>
              
              <label class="sync-option">
                <input type="radio" name="auto_sync" value="enabled" id="sync-enabled">
                <span class="sync-label">Auto-Sync</span>
                <span class="sync-desc">Automatically update on GitHub changes</span>
              </label>
            </div>
            
            <div class="github-token-input" id="github-token-input" style="display: none;">
              {% if user.is_authenticated and user.profile.has_github_token %}
                <div class="token-status">
                  <span style="color: #28a745;">✓ GitHub token configured</span>
                  <small>Using stored token from your profile</small>
                </div>
              {% else %}
                <label for="github_token">GitHub Personal Access Token:</label>
                <input type="password" name="github_token" id="github_token" placeholder="ghp_xxxxxxxxxxxxxxxx">
                <small>Required for auto-sync. Token needs 'repo' and 'admin:repo_hook' permissions.</small>
                <div class="token-help">
                  <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token" target="_blank">How to create a GitHub token?</a>
                  {% if user.is_authenticated %}
                    | <a href="{% url 'profile' user.username %}">Manage tokens in profile</a>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </div>          
          <div class="visibility-options">
            {% if user.is_authenticated %}
              <label>
                <input type="radio" name="visibility" value="public" checked>
                <span class="visibility-label">Public</span>
                <span class="visibility-desc">Anyone can view</span>
              </label>
              
              <label>
                <input type="radio" name="visibility" value="private">
                <span class="visibility-label">Private</span>
                <span class="visibility-desc">Only you can view</span>
              </label>
            {% else %}
              <label>
                <input type="radio" name="visibility" value="public" checked>
                <span class="visibility-label">Public</span>
                <span class="visibility-desc">Anyone can view</span>
              </label>
              
              <label class="disabled">
                <input type="radio" name="visibility" value="private" disabled>
                <span class="visibility-label">Private</span>
                <span class="visibility-desc">Only you can view</span>
                <span class="login-prompt">Sign in to use this option</span>
              </label>
            {% endif %}
            
{% if user.is_authenticated %}
            {% if user_organizations %}
              <label>
                <input type="radio" name="visibility" value="organization">
                <span class="visibility-label">Organization</span>
                <span class="visibility-desc">Share with your team</span>
              </label>
              
              <div class="org-select-wrapper" id="org-select-wrapper">
                <select name="organization_id" id="organization-select">
                  {% for org in user_organizations %}
                  <option value="{{ org.id }}">{{ org.name }}</option>
                  {% endfor %}
                </select>
              </div>
            {% else %}
              <label class="disabled">
                <input type="radio" name="visibility" value="organization" disabled>
                <span class="visibility-label">Organization</span>
                <span class="visibility-desc">You don't have any organizations</span>
              </label>
            {% endif %}
          {% else %}
            <label class="disabled">
              <input type="radio" name="visibility" value="organization" disabled>
              <span class="visibility-label">Organization</span>
              <span class="visibility-desc">Share with your team</span>
              <span class="login-prompt">Sign in to use this option</span>
            </label>
          {% endif %}          </div>
          
          <button class="submit-button" type="submit" id="generate-btn">Generate Documentation</button>
        </form>
      </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
      <div class="loading-content">
        <button class="close-btn" id="close-overlay-btn">×</button>
        <div class="loading-bar-container">
          <div class="loading-bar" id="loading-bar"></div>
        </div>
        <div class="loading-percentage" id="loading-percentage">0%</div>
        <div class="loading-quote">"To build anything that truly lasts, it takes time"</div>
        <div class="loading-complete" id="loading-complete">
          <h3>Documentation Ready!</h3>
          <a href="#" class="view-link" id="view-doc-link">View Documentation</a>
        </div>
      </div>
    </div>

    {% if message %}
      <div class="success-message">{{ message }}</div>
    {% endif %}
    
    {% if error %}
      <div class="error-message">{{ error }}</div>
    {% endif %}

    <div class="navigation-boxes">
      <a href="{% url 'organization_list' %}" class="nav-box">
        <div class="nav-box-content">
          <h3 style="font-size: 1rem;">Organization</h3>
          <p>Create or join a team workspace</p>
        </div>
      </a>
      <a href="{% url 'developer_console:dashboard' %}" class="nav-box">
        <div class="nav-box-content">
          <h3 style="font-size: 1rem;">Developer Console</h3>
          <p>Manage auto-sync and view logs</p>
        </div>
      </a>
    </div>
    
    <!-- Tabs for document types -->
    <div class="doc-tabs">
      <button class="tab-btn active" data-tab="public">Public Repos</button>
      <button class="tab-btn" data-tab="my-repos">My Repos</button>
      <button class="tab-btn" data-tab="private">Private Repos</button>
      <button class="tab-btn" data-tab="organization">Organization Repos</button>
    </div>
    
    <!-- Public Repos Tab (default) -->
    <div class="tab-content active" id="public-tab">
      <div class="docs-grid">
        {% for doc in doc_folders %}
          <a href="{% url 'view_doc' doc.id %}" class="doc-link">
            <div class="doc-card">
              <div class="doc-name">{{ doc.folder_name }}</div>
              <div class="doc-meta">
                <div class="doc-date">{{ doc.uploaded_at|date:"F j, Y" }}</div>
                <div class="doc-visibility">Public</div>
              </div>
            </div>
          </a>
        {% empty %}
          <p>No public documentation available.</p>
        {% endfor %}
      </div>
      {% if public_doc_count > doc_folders|length %}
        <div class="see-more-link">
          <a href="{% url 'public_repos_list' %}" class="white-button">See all {{ public_doc_count }} public repositories</a>
        </div>
      {% endif %}
    </div>
    
    <!-- My Repos Tab -->
    <div class="tab-content" id="my-repos-tab">
      {% if user.is_authenticated %}
        <div class="docs-grid">
          {% for doc in my_doc_folders %}
            <a href="{% url 'view_doc' doc.id %}" class="doc-link">
              <div class="doc-card">
                <div class="doc-name">{{ doc.folder_name }}</div>
                <div class="doc-meta">
                  <div class="doc-date">{{ doc.uploaded_at|date:"F j, Y" }}</div>
                  <div class="doc-visibility">{{ doc.get_visibility_display }}</div>
                  {% if doc.organization %}
                    <div class="doc-org">{{ doc.organization.name }}</div>
                  {% endif %}
                </div>
              </div>
            </a>
          {% empty %}
            <p>You haven't created any documentation yet. Upload a repository to get started.</p>
          {% endfor %}
        </div>
        {% if my_doc_count > my_doc_folders|length %}
          <div class="see-more-link">
            <a href="{% url 'my_repos_list' %}" class="white-button">See all {{ my_doc_count }} repositories</a>
          </div>
        {% endif %}
      {% else %}
        <div class="signin-prompt">
          <p>Sign in to view your repositories</p>
          <a href="{% url 'social:begin' 'github' %}" class="white-button">
            <svg class="github-icon" viewBox="0 0 24 24" fill="black" style="width: 20px; height: 20px; margin-right: 8px;">
              <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/>
            </svg>
            Sign in with GitHub
          </a>
        </div>
      {% endif %}
    </div>
    
    <!-- Private Repos Tab -->
    <div class="tab-content" id="private-tab">
      {% if user.is_authenticated %}
        <div class="docs-grid">
          {% for doc in private_doc_folders %}
            <a href="{% url 'view_doc' doc.id %}" class="doc-link">
              <div class="doc-card">
                <div class="doc-name">{{ doc.folder_name }}</div>
                <div class="doc-meta">
                  <div class="doc-date">{{ doc.uploaded_at|date:"F j, Y" }}</div>
                  <div class="doc-visibility">Private</div>
                </div>
              </div>
            </a>
          {% empty %}
            <p>You don't have any private repositories yet.</p>
          {% endfor %}
        </div>
        {% if private_doc_count > private_doc_folders|length %}
          <div class="see-more-link">
            <a href="{% url 'private_repos_list' %}" class="white-button">See all {{ private_doc_count }} private repositories</a>
          </div>
        {% endif %}
      {% else %}
        <div class="signin-prompt">
          <p>Sign in to view your private repositories</p>
          <a href="{% url 'social:begin' 'github' %}" class="white-button">
            <svg class="github-icon" viewBox="0 0 24 24" fill="black" style="width: 20px; height: 20px; margin-right: 8px;">
              <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/>
            </svg>
            Sign in with GitHub
          </a>
        </div>
      {% endif %}
    </div>
    
    <!-- Organization Repos Tab -->
    <div class="tab-content" id="organization-tab">
      {% if user.is_authenticated %}
        <div class="docs-grid">
          {% for doc in org_doc_folders %}
            <a href="{% url 'view_doc' doc.id %}" class="doc-link">
              <div class="doc-card">
                <div class="doc-name">{{ doc.folder_name }}</div>
                <div class="doc-meta">
                  <div class="doc-date">{{ doc.uploaded_at|date:"F j, Y" }}</div>
                  {% if doc.organization %}
                    <div class="doc-org">{{ doc.organization.name }}</div>
                  {% endif %}
                </div>
              </div>
            </a>
          {% empty %}
            <p>No organization repositories available.</p>
          {% endfor %}
        </div>
        {% if org_doc_count > org_doc_folders|length %}
          <div class="see-more-link">
            <a href="{% url 'organization_repos_list' %}" class="white-button">See all {{ org_doc_count }} organization repositories</a>
          </div>
        {% endif %}
      {% else %}
        <div class="signin-prompt">
          <p>Sign in to view organization repositories</p>
          <a href="{% url 'social:begin' 'github' %}" class="white-button">
            <svg class="github-icon" viewBox="0 0 24 24" fill="black" style="width: 20px; height: 20px; margin-right: 8px;">
              <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/>
            </svg>
            Sign in with GitHub
          </a>
        </div>
      {% endif %}
    </div>
  </div>

{% if latest_doc_id %}
  <input type="hidden" id="latest-doc-id" value="{{ latest_doc_id }}">
{% endif %}

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/index.js' %}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Tab switching functionality
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        // Remove active class from all buttons and contents
        tabButtons.forEach(btn => btn.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));
        
        // Add active class to current button
        button.classList.add('active');
        
        // Show corresponding content
        const tabId = button.getAttribute('data-tab');
        document.getElementById(tabId + '-tab').classList.add('active');
      });
    });
    
    // Auto-sync options functionality
    const githubUrlInput = document.getElementById('github-url');
    const syncOptions = document.getElementById('github-sync-options');
    const syncRadios = document.querySelectorAll('input[name="auto_sync"]');
    const tokenInput = document.getElementById('github-token-input');
    
    // Show sync options when GitHub URL is entered
    githubUrlInput.addEventListener('input', function() {
      if (this.value.includes('github.com')) {
        syncOptions.style.display = 'block';
      } else {
        syncOptions.style.display = 'none';
      }
    });
    
    // Show/hide token input based on sync option
    syncRadios.forEach(radio => {
      radio.addEventListener('change', function() {
        if (this.value === 'enabled') {
          tokenInput.style.display = 'block';
        } else {
          tokenInput.style.display = 'none';
        }
      });
    });
  });
</script>
{% endblock %}


